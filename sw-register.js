/*
 * AniFox 2.4 - Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Service Worker Ð¸ PWA
 * 
 * ðŸ’» Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð¾ SerGio Play
 * ðŸŒ Ð’ÐµÐ±-ÑÐ°Ð¹Ñ‚: https://sergioplay-dev.vercel.app/
 * ðŸ“ GitHub: https://github.com/SerGioPlay01/anifox-search
 * 
 * ÐŸÑ€Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹Ñ‚Ðµ ÑÑÑ‹Ð»ÐºÑƒ Ð½Ð° Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°.
 * 
 * Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸:
 * - Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Service Worker Ð´Ð»Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
 * - PWA ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
 * - Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ð¼ Ð±Ð°Ð½Ð½ÐµÑ€Ð¾Ð¼
 */

// ===========================================
// SERVICE WORKER
// ===========================================

// Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Service Worker Ð´Ð»Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/service-worker.js')
      .then(function(registration) {
        console.log('ServiceWorker registration successful');
      })
      .catch(function(error) {
        console.log('ServiceWorker registration failed: ', error);
      });
  });
}

// ===========================================
// PWA Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ
// ===========================================

// ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹ PWA
let deferredPrompt;                    // ÐžÑ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
const installButton = document.createElement('button');  // ÐšÐ½Ð¾Ð¿ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸ Ðº ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ PWA
window.addEventListener('beforeinstallprompt', (e) => {
  // ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ Ð±Ð°Ð½Ð½ÐµÑ€Ð°
  e.preventDefault();
  deferredPrompt = e;
  
  // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ²Ð¾ÑŽ ÐºÐ½Ð¾Ð¿ÐºÑƒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
  showInstallButton();
});

/**
 * Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ PWA
 * Ð¡Ñ‚Ð¸Ð»Ð¸Ð·ÑƒÐµÑ‚ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð¸ÐºÐ°
 */
function showInstallButton() {
  // Ð¡Ñ‚Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
  installButton.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 20px;
    background: #5b0a99;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    z-index: 1000;
  `;
  installButton.textContent = 'Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ';
  document.body.appendChild(installButton);
  
  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð¸ÐºÐ° Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
  installButton.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð±Ð°Ð½Ð½ÐµÑ€
    deferredPrompt.prompt();
    
    // Ð–Ð´ÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('User accepted the install prompt');
      installButton.style.display = 'none';
    } else {
      console.log('User dismissed the install prompt');
    }
    
    deferredPrompt = null;
  });
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ PWA
window.addEventListener('appinstalled', () => {
  console.log('PWA was installed');
  installButton.style.display = 'none';
  deferredPrompt = null;
});